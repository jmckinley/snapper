# Snapper - Production Docker Compose Override
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
#
# All environment variables are now read from .env via ${VAR:-default} in the
# base compose. This file only overrides structural differences for production:
# build target, port binding, and volume mounts.
services:
  app:
    image: ghcr.io/jmckinley/snapper:latest
    build:
      target: production
    ports: !override
      - "127.0.0.1:8000:8000"
    volumes: !reset []

  postgres:
    ports: !reset []

  redis:
    ports: !reset []

  caddy:
    # Disabled in prod — system Caddy already proxies :8443 → :8000.
    # Re-enable if deploying without a system-level reverse proxy.
    profiles: ["caddy-sidecar"]

  celery-worker:
    image: ghcr.io/jmckinley/snapper:latest
    build:
      target: production
    volumes: !reset []

  celery-beat:
    image: ghcr.io/jmckinley/snapper:latest
    build:
      target: production
    volumes: !reset []

  # Production monitoring overrides
  grafana:
    ports:
      - "127.0.0.1:3000:3000"
    environment:
      - GF_SERVER_ROOT_URL=https://${SERVER_LABEL:-localhost}:${SNAPPER_PORT:-8443}/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
