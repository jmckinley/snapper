# Snapper - Environment Configuration
# Copy this file to .env and customize the values
#
# For local development: defaults work out of the box with Docker Compose
# For production: see "PRODUCTION DEPLOYMENT" section at the bottom

# ============================================
# REQUIRED SETTINGS
# ============================================

# Application secret key (generate with: openssl rand -hex 32)
SECRET_KEY=your-secret-key-here-generate-with-openssl-rand-hex-32

# Database URL (use postgres hostname for Docker Compose)
DATABASE_URL=postgresql+asyncpg://snapper:snapper@postgres:5432/snapper

# Redis URL
REDIS_URL=redis://redis:6379/0

# ============================================
# SECURITY SETTINGS
# ============================================
# These are DEVELOPMENT defaults. For production, deploy.sh generates
# hardened values: LEARNING_MODE=false, DENY_BY_DEFAULT=true,
# REQUIRE_API_KEY=true, REQUIRE_VAULT_AUTH=true.

# Learning Mode (recommended for initial setup/tuning)
# When true: logs what would be blocked but doesn't actually block
# Set to false once you've tuned your rules
LEARNING_MODE=true

# Deny requests by default when no rules match
# Only enforced when LEARNING_MODE=false
DENY_BY_DEFAULT=false

# Require API key for agent requests
# Each agent gets a unique key (snp_xxx) on creation
REQUIRE_API_KEY=false

# Require API key for PII vault write operations
REQUIRE_VAULT_AUTH=false

# Validate WebSocket origin headers (CVE-2026-25253 mitigation)
VALIDATE_WEBSOCKET_ORIGIN=true

# Restrict access to localhost only (set false when behind reverse proxy)
REQUIRE_LOCALHOST_ONLY=false

# Allowed origins for CORS/WebSocket (comma-separated)
# Production: set to your public URL, e.g. https://yourdomain.com:8443
ALLOWED_ORIGINS=http://localhost:8000,http://127.0.0.1:8000

# Allowed hosts for Host header validation (comma-separated)
# Production: add your domain/IP, e.g. yourdomain.com,localhost,app
ALLOWED_HOSTS=localhost,127.0.0.1,app

# CORS allowed origins (comma-separated)
CORS_ORIGINS=http://localhost:8000,http://127.0.0.1:8000

# ============================================
# APPLICATION
# ============================================

# Debug mode (set false in production)
DEBUG=true
ENVIRONMENT=development
LOG_LEVEL=DEBUG

# Rate limiting
RATE_LIMIT_ENABLED=true
RATE_LIMIT_DEFAULT_MAX_REQUESTS=100
RATE_LIMIT_DEFAULT_WINDOW_SECONDS=60

# Circuit breaker
CIRCUIT_BREAKER_FAILURE_THRESHOLD=5
CIRCUIT_BREAKER_RECOVERY_TIMEOUT=30
CIRCUIT_BREAKER_HALF_OPEN_MAX_CALLS=3

# ============================================
# CELERY (Task Queue)
# ============================================

CELERY_BROKER_URL=redis://redis:6379/1
CELERY_RESULT_BACKEND=redis://redis:6379/2

# ============================================
# DOCKER COMPOSE (Optional Overrides)
# ============================================

# PostgreSQL container credentials
POSTGRES_USER=snapper
POSTGRES_PASSWORD=snapper
POSTGRES_DB=snapper

# Host port bindings (set to empty to disable external access)
# APP_PORT=8000
# POSTGRES_PORT=5432
# REDIS_PORT=6379

# ============================================
# EXTERNAL API KEYS (Optional)
# ============================================

# NVD API key for vulnerability data
# Get one at: https://nvd.nist.gov/developers/request-an-api-key
NVD_API_KEY=

# GitHub token for security advisories
# Generate at: https://github.com/settings/tokens
GITHUB_TOKEN=

# ============================================
# ALERTING (Optional)
# ============================================

# Email alerts (SMTP)
SMTP_HOST=
SMTP_PORT=587
SMTP_USER=
SMTP_PASSWORD=
SMTP_FROM_EMAIL=alerts@snapper.local

# Slack webhook URL (legacy — for simple webhook-only alerts)
SLACK_WEBHOOK_URL=

# Slack Bot (interactive approvals, rule management, PII vault)
# See docs/SLACK_SETUP.md for detailed instructions
#
# 1. Create app at https://api.slack.com/apps → "From scratch"
# 2. Enable Socket Mode → copy app-level token (xapp-...)
# 3. Add bot scopes: chat:write, commands, im:history, im:write, users:read
# 4. Install to workspace → copy bot token (xoxb-...)
# 5. Register slash commands: /snapper-rules, /snapper-test, etc.
#
SLACK_BOT_TOKEN=
SLACK_APP_TOKEN=
SLACK_ALERT_CHANNEL=

# Telegram Bot (test rules, manage approvals from your phone)
# See docs/TELEGRAM_SETUP.md for detailed instructions
#
# 1. Create bot: Message @BotFather with /newbot
# 2. Use naming convention: snapper_<yourname>_bot
# 3. Paste token here, then send /start to get your Chat ID
#
TELEGRAM_BOT_TOKEN=
TELEGRAM_CHAT_ID=

# PagerDuty API key (for critical alerts)
PAGERDUTY_API_KEY=

# Generic webhook URL
GENERIC_WEBHOOK_URL=

# ============================================
# NOTIFICATION PREFERENCES
# ============================================

# Send notifications when actions are blocked (default: true)
NOTIFY_ON_BLOCK=true

# Send notifications for approval requests (default: true)
NOTIFY_ON_APPROVAL_REQUEST=true

# Send notifications when actions are allowed (verbose, default: false)
NOTIFY_ON_ALLOW=false

# ============================================
# PRODUCTION DEPLOYMENT
# ============================================
# For production behind a reverse proxy (e.g., Caddy), set:
#
#   SECRET_KEY=<openssl rand -hex 32>
#   DEBUG=false
#   LOG_LEVEL=INFO
#   ENVIRONMENT=production
#   REQUIRE_LOCALHOST_ONLY=false
#   ALLOWED_ORIGINS=https://your-domain-or-ip:port
#   ALLOWED_HOSTS=your-domain-or-ip,localhost,app
#   CORS_ORIGINS=https://your-domain-or-ip:port
#
# Then deploy with:
#   ./deploy.sh
#
# Or manually:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml run --rm app alembic upgrade head
