{% extends "base.html" %}

{% block title %}Edit Rule - Snapper{% endblock %}

{% block header %}
<header class="bg-white shadow">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <nav class="flex" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-4">
                <li>
                    <a href="/rules" class="text-gray-400 hover:text-gray-500">Rules</a>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg class="h-5 w-5 flex-shrink-0 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" />
                        </svg>
                        <span class="ml-4 text-sm font-medium text-gray-500">Edit Rule</span>
                    </div>
                </li>
            </ol>
        </nav>
        <h1 class="mt-2 text-3xl font-bold tracking-tight text-gray-900">Edit Rule</h1>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="max-w-3xl">
    <div id="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary-500 border-t-transparent"></div>
        <p class="mt-3 text-gray-600">Loading rule...</p>
    </div>

    <form id="edit-rule-form" class="space-y-6 hidden">
        <!-- Basic Info -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Basic Information</h3>
            <div class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Rule Name</label>
                    <input type="text" name="name" id="name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea name="description" id="description" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm"></textarea>
                </div>
                <div>
                    <label for="agent_id" class="block text-sm font-medium text-gray-700">Agent</label>
                    <select name="agent_id" id="agent_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                        <option value="">Global (all agents)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Rule Type (read-only) -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Rule Type</h3>
            <div>
                <label class="block text-sm font-medium text-gray-700">Type</label>
                <div id="rule_type_display" class="mt-1 px-3 py-2 bg-gray-100 rounded-md text-sm text-gray-700"></div>
                <input type="hidden" name="rule_type" id="rule_type">
                <p class="mt-1 text-xs text-gray-500">Rule type cannot be changed after creation</p>
            </div>
        </div>

        <!-- Action & Priority -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Action & Priority</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="action" class="block text-sm font-medium text-gray-700">Action</label>
                    <select name="action" id="action" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                        <option value="deny">Deny</option>
                        <option value="allow">Allow</option>
                        <option value="require_approval">Require Approval</option>
                        <option value="log_only">Log Only</option>
                    </select>
                </div>
                <div>
                    <label for="priority" class="block text-sm font-medium text-gray-700">Priority</label>
                    <input type="number" name="priority" id="priority" value="0" min="-1000" max="1000" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                </div>
            </div>
            <div class="mt-4">
                <label class="flex items-center">
                    <input type="checkbox" name="is_active" id="is_active" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Rule is active</span>
                </label>
            </div>
        </div>

        <!-- Parameters -->
        <div id="parameters-section" class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Parameters</h3>
            <div id="parameters-fields">
                <!-- Populated dynamically -->
            </div>
        </div>

        <!-- Submit -->
        <div class="flex justify-between">
            <button type="button" onclick="deleteRule()" class="inline-flex items-center px-4 py-2 border border-red-300 shadow-sm text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                Delete Rule
            </button>
            <div class="flex space-x-3">
                <a href="/rules" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    Cancel
                </a>
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    Save Changes
                </button>
            </div>
        </div>
    </form>

    <div id="error" class="hidden text-center py-12">
        <svg class="mx-auto h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <p id="error-message" class="mt-2 text-red-600">Failed to load rule</p>
        <a href="/rules" class="mt-4 inline-block text-primary-600 hover:text-primary-500">Back to Rules</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const ruleId = window.location.pathname.split('/').pop();
    let currentRule = null;
    const arrayData = {};

    const parameterSchemas = {
        command_allowlist: {
            patterns: { type: 'array', label: 'Allowed Command Patterns' }
        },
        command_denylist: {
            patterns: { type: 'array', label: 'Denied Command Patterns' }
        },
        skill_allowlist: {
            skills: { type: 'array', label: 'Allowed Skill IDs' },
            allow_verified_only: { type: 'checkbox', label: 'Allow Verified Only' }
        },
        skill_denylist: {
            skills: { type: 'array', label: 'Denied Skill IDs' },
            auto_block_flagged: { type: 'checkbox', label: 'Auto-block Flagged Skills' }
        },
        rate_limit: {
            max_requests: { type: 'number', label: 'Max Requests' },
            window_seconds: { type: 'number', label: 'Window (seconds)' },
            scope: { type: 'select', label: 'Scope', options: ['agent', 'ip', 'user'] }
        },
        time_restriction: {
            start_hour: { type: 'number', label: 'Start Hour (0-23)', min: 0, max: 23 },
            end_hour: { type: 'number', label: 'End Hour (0-23)', min: 0, max: 23 },
            allowed_days: { type: 'multiselect', label: 'Allowed Days', options: [
                { value: 0, label: 'Monday' },
                { value: 1, label: 'Tuesday' },
                { value: 2, label: 'Wednesday' },
                { value: 3, label: 'Thursday' },
                { value: 4, label: 'Friday' },
                { value: 5, label: 'Saturday' },
                { value: 6, label: 'Sunday' }
            ]}
        },
        origin_validation: {
            allowed_origins: { type: 'array', label: 'Allowed Origins' },
            strict_mode: { type: 'checkbox', label: 'Strict Mode' }
        },
        credential_protection: {
            protected_patterns: { type: 'array', label: 'Protected Patterns' },
            block_plaintext_secrets: { type: 'checkbox', label: 'Block Plaintext Secrets' }
        },
        localhost_restriction: {
            enabled: { type: 'checkbox', label: 'Enabled' },
            allowed_ips: { type: 'array', label: 'Allowed IPs' }
        },
        network_egress: {
            allowed_hosts: { type: 'array', label: 'Allowed Hosts' },
            denied_hosts: { type: 'array', label: 'Denied Hosts' }
        },
        human_in_loop: {
            require_approval_for: { type: 'array', label: 'Require Approval For' },
            timeout_seconds: { type: 'number', label: 'Timeout (seconds)' },
            auto_deny_on_timeout: { type: 'checkbox', label: 'Auto-deny on Timeout' }
        },
        file_access: {
            allowed_paths: { type: 'array', label: 'Allowed Paths' },
            denied_paths: { type: 'array', label: 'Denied Paths' }
        }
    };

    async function loadRule() {
        try {
            const response = await fetch(`/api/v1/rules/${ruleId}`);
            if (!response.ok) throw new Error('Rule not found');

            currentRule = await response.json();
            populateForm(currentRule);

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('edit-rule-form').classList.remove('hidden');
        } catch (error) {
            console.error('Failed to load rule:', error);
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('error-message').textContent = error.message || 'Failed to load rule';
        }
    }

    function populateForm(rule) {
        document.getElementById('name').value = rule.name || '';
        document.getElementById('description').value = rule.description || '';
        document.getElementById('agent_id').value = rule.agent_id || '';
        document.getElementById('rule_type').value = rule.rule_type;
        document.getElementById('rule_type_display').textContent = formatRuleType(rule.rule_type);
        document.getElementById('action').value = rule.action;
        document.getElementById('priority').value = rule.priority || 0;
        document.getElementById('is_active').checked = rule.is_active;

        // Populate parameters
        populateParameters(rule.rule_type, rule.parameters || {});
    }

    function populateParameters(ruleType, params) {
        const section = document.getElementById('parameters-section');
        const container = document.getElementById('parameters-fields');
        const schema = parameterSchemas[ruleType];

        if (!schema) {
            section.classList.add('hidden');
            return;
        }

        section.classList.remove('hidden');
        let html = '';

        for (const [key, config] of Object.entries(schema)) {
            const value = params[key];
            html += `<div class="mb-4">`;
            html += `<label class="block text-sm font-medium text-gray-700">${config.label}</label>`;

            if (config.type === 'array') {
                arrayData[key] = Array.isArray(value) ? [...value] : [];
                html += `<div id="array-${key}" class="mt-1 space-y-2">`;
                html += `<div class="flex space-x-2">`;
                html += `<input type="text" class="flex-1 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm" data-array="${key}">`;
                html += `<button type="button" onclick="addArrayItem('${key}')" class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">Add</button>`;
                html += `</div>`;
                html += `<div id="array-items-${key}" class="space-y-1"></div>`;
                html += `</div>`;
            } else if (config.type === 'number') {
                html += `<input type="number" name="param_${key}" value="${value !== undefined ? value : ''}" ${config.min !== undefined ? `min="${config.min}"` : ''} ${config.max !== undefined ? `max="${config.max}"` : ''} class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm">`;
            } else if (config.type === 'checkbox') {
                html += `<input type="checkbox" name="param_${key}" ${value ? 'checked' : ''} class="mt-1 h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">`;
            } else if (config.type === 'select') {
                html += `<select name="param_${key}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm">`;
                for (const opt of config.options) {
                    html += `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`;
                }
                html += `</select>`;
            } else if (config.type === 'multiselect') {
                html += `<div class="mt-1 space-y-2">`;
                for (const opt of config.options) {
                    const checked = Array.isArray(value) && value.includes(opt.value);
                    html += `<label class="flex items-center">`;
                    html += `<input type="checkbox" name="param_${key}" value="${opt.value}" ${checked ? 'checked' : ''} class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">`;
                    html += `<span class="ml-2 text-sm text-gray-700">${opt.label}</span>`;
                    html += `</label>`;
                }
                html += `</div>`;
            }

            html += `</div>`;
        }

        container.innerHTML = html;

        // Update array displays
        for (const key of Object.keys(arrayData)) {
            updateArrayDisplay(key);
        }
    }

    function addArrayItem(key) {
        const input = document.querySelector(`input[data-array="${key}"]`);
        const value = input.value.trim();
        if (!value) return;

        if (!arrayData[key]) arrayData[key] = [];
        arrayData[key].push(value);
        input.value = '';
        updateArrayDisplay(key);
    }

    function removeArrayItem(key, index) {
        arrayData[key].splice(index, 1);
        updateArrayDisplay(key);
    }

    function updateArrayDisplay(key) {
        const container = document.getElementById(`array-items-${key}`);
        if (!container) return;

        container.innerHTML = (arrayData[key] || []).map((item, index) => `
            <div class="flex items-center justify-between px-3 py-2 bg-gray-100 rounded text-sm">
                <span class="break-all">${escapeHtml(item)}</span>
                <button type="button" onclick="removeArrayItem('${key}', ${index})" class="ml-2 text-red-500 hover:text-red-700 flex-shrink-0">&times;</button>
            </div>
        `).join('');
    }

    function formatRuleType(type) {
        return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function loadAgents() {
        try {
            const response = await fetch('/api/v1/agents?page_size=100');
            const data = await response.json();
            const select = document.getElementById('agent_id');
            data.items.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = agent.name;
                select.appendChild(option);
            });

            // Re-select the current agent after loading
            if (currentRule && currentRule.agent_id) {
                select.value = currentRule.agent_id;
            }
        } catch (error) {
            console.error('Failed to load agents:', error);
        }
    }

    async function deleteRule() {
        if (!confirm('Are you sure you want to delete this rule?')) return;

        try {
            const response = await fetch(`/api/v1/rules/${ruleId}`, { method: 'DELETE' });
            if (response.ok) {
                window.location.href = '/rules';
            } else {
                throw new Error('Failed to delete rule');
            }
        } catch (error) {
            alert('Failed to delete rule: ' + error.message);
        }
    }

    document.getElementById('edit-rule-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const ruleType = formData.get('rule_type');
        const schema = parameterSchemas[ruleType];

        // Build parameters
        const parameters = {};
        if (schema) {
            for (const [key, config] of Object.entries(schema)) {
                if (config.type === 'array') {
                    parameters[key] = arrayData[key] || [];
                } else if (config.type === 'number') {
                    const val = formData.get(`param_${key}`);
                    parameters[key] = val ? parseInt(val) : null;
                } else if (config.type === 'checkbox') {
                    parameters[key] = formData.get(`param_${key}`) === 'on';
                } else if (config.type === 'select') {
                    parameters[key] = formData.get(`param_${key}`);
                } else if (config.type === 'multiselect') {
                    parameters[key] = formData.getAll(`param_${key}`).map(v => isNaN(v) ? v : parseInt(v));
                }
            }
        }

        const rule = {
            name: formData.get('name'),
            description: formData.get('description'),
            agent_id: formData.get('agent_id') || null,
            action: formData.get('action'),
            priority: parseInt(formData.get('priority')) || 0,
            parameters: parameters,
            is_active: formData.get('is_active') === 'on'
        };

        try {
            const response = await fetch(`/api/v1/rules/${ruleId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rule)
            });

            if (response.ok) {
                window.location.href = '/rules';
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'Failed to update rule'));
            }
        } catch (error) {
            console.error('Failed to update rule:', error);
            alert('Failed to update rule');
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        loadRule();
        loadAgents();
    });
</script>
{% endblock %}
