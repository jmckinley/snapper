{% extends "admin/base.html" %}
{% block title %}Org Detail — Admin{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="/admin/orgs" class="text-sm text-gray-500 hover:text-gray-700">&larr; Back to Organizations</a>
</div>

<div id="org-detail">
    <div class="text-center text-gray-500 py-12">Loading...</div>
</div>
{% endblock %}

{% block scripts %}
<script>
const orgId = '{{ org_id }}';

async function loadOrgDetail() {
    const res = await fetch(`/api/v1/meta/orgs/${orgId}`, { credentials: 'include' });
    if (!res.ok) {
        document.getElementById('org-detail').innerHTML = '<div class="text-center text-red-600 py-12">Organization not found</div>';
        return;
    }
    const org = await res.json();
    const container = document.getElementById('org-detail');

    const domains = (org.allowed_email_domains || []).map(d => `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-gray-100 text-gray-700">${d}</span>`).join(' ') || '<span class="text-gray-400">Any domain</span>';

    const features = Object.entries(org.feature_overrides || {}).map(([k, v]) =>
        `<div class="flex items-center justify-between py-1">
            <span class="text-sm text-gray-700">${k}</span>
            <span class="text-sm font-medium ${v ? 'text-green-600' : 'text-red-600'}">${v ? 'On' : 'Off'}</span>
        </div>`
    ).join('') || '<p class="text-sm text-gray-400">No overrides</p>';

    const usage = org.usage || {};
    function usageBar(key, label) {
        const stat = usage[key] || { used: 0, limit: 0, is_unlimited: false };
        const pct = stat.is_unlimited ? 0 : (stat.limit > 0 ? Math.min(100, Math.round(stat.used / stat.limit * 100)) : 0);
        const limitStr = stat.is_unlimited ? 'unlimited' : stat.limit;
        return `<div class="mb-2">
            <div class="flex justify-between text-xs text-gray-500 mb-1"><span>${label}</span><span>${stat.used} / ${limitStr}</span></div>
            <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-amber-500 h-2 rounded-full" style="width: ${pct}%"></div></div>
        </div>`;
    }

    const auditRows = (org.recent_audit || []).map(a =>
        `<tr><td class="px-4 py-2 text-xs text-gray-500">${a.created_at ? new Date(a.created_at).toLocaleString() : ''}</td>
             <td class="px-4 py-2 text-xs">${a.action}</td>
             <td class="px-4 py-2 text-xs text-gray-600">${a.message || ''}</td></tr>`
    ).join('');

    container.innerHTML = `
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">${org.name}</h1>
                <p class="text-sm text-gray-500">${org.slug} &middot; Created ${new Date(org.created_at).toLocaleDateString()}</p>
            </div>
            <div class="flex items-center space-x-3">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${org.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${org.is_active ? 'Active' : 'Suspended'}
                </span>
                <button onclick="impersonate('${org.id}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm">Impersonate</button>
                <button onclick="toggleSuspend('${org.id}', ${org.is_active})" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded-md text-sm">
                    ${org.is_active ? 'Suspend' : 'Activate'}
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Info -->
            <div class="bg-white shadow rounded-lg p-5">
                <h3 class="text-sm font-medium text-gray-500 mb-3">Info</h3>
                <dl class="space-y-2 text-sm">
                    <div class="flex justify-between"><dt class="text-gray-500">Plan</dt><dd class="font-medium">${org.plan_id}</dd></div>
                    <div class="flex justify-between"><dt class="text-gray-500">Owner</dt><dd>${org.owner_email || '—'}</dd></div>
                    <div class="flex justify-between"><dt class="text-gray-500">Members</dt><dd>${org.member_count}</dd></div>
                    <div class="flex justify-between"><dt class="text-gray-500">Agents</dt><dd>${org.agent_count}</dd></div>
                    <div class="flex justify-between"><dt class="text-gray-500">Max Seats</dt><dd>${org.max_seats || 'Plan default'}</dd></div>
                    <div class="flex justify-between"><dt class="text-gray-500">Stripe</dt><dd>${org.subscription_status || '—'}</dd></div>
                </dl>
                <div class="mt-3"><span class="text-xs text-gray-500">Allowed Domains:</span><div class="mt-1 flex flex-wrap gap-1">${domains}</div></div>
            </div>

            <!-- Usage -->
            <div class="bg-white shadow rounded-lg p-5">
                <h3 class="text-sm font-medium text-gray-500 mb-3">Usage</h3>
                ${usageBar('agents', 'Agents')}
                ${usageBar('rules', 'Rules')}
                ${usageBar('vault_entries', 'Vault Entries')}
                ${usageBar('team_members', 'Team Members')}
                ${usageBar('teams', 'Teams')}
            </div>

            <!-- Features -->
            <div class="bg-white shadow rounded-lg p-5">
                <h3 class="text-sm font-medium text-gray-500 mb-3">Feature Overrides</h3>
                ${features}
                <div class="mt-4">
                    <h4 class="text-xs text-gray-500 mb-2">Plan: ${usage.plan_name || org.plan_id}</h4>
                </div>
            </div>
        </div>

        <!-- Plan change -->
        <div class="bg-white shadow rounded-lg p-5 mb-6">
            <h3 class="text-sm font-medium text-gray-500 mb-3">Change Plan</h3>
            <div class="flex items-center space-x-3">
                <select id="plan-select" class="rounded-md border-gray-300 shadow-sm text-sm px-3 py-2 border">
                    <option value="free" ${org.plan_id === 'free' ? 'selected' : ''}>Free</option>
                    <option value="pro" ${org.plan_id === 'pro' ? 'selected' : ''}>Pro</option>
                    <option value="enterprise" ${org.plan_id === 'enterprise' ? 'selected' : ''}>Enterprise</option>
                </select>
                <button onclick="changePlan('${org.id}')" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-md text-sm">Update Plan</button>
            </div>
        </div>

        <!-- Recent Audit -->
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-200"><h3 class="text-sm font-medium text-gray-900">Recent Activity</h3></div>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Time</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Action</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Message</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">${auditRows || '<tr><td colspan="3" class="px-4 py-3 text-center text-sm text-gray-400">No activity</td></tr>'}</tbody>
            </table>
        </div>
    `;
}

async function impersonate(id) {
    if (!confirm('Start impersonating this organization?')) return;
    const res = await fetch('/api/v1/meta/impersonate', {
        method: 'POST', credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ org_id: id })
    });
    if (res.ok) window.location.href = '/';
    else alert('Failed');
}

async function toggleSuspend(id, isActive) {
    const action = isActive ? 'suspend' : 'activate';
    if (!confirm(`Are you sure you want to ${action} this organization?`)) return;
    const res = await fetch(`/api/v1/meta/orgs/${id}`, {
        method: 'PATCH', credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_active: !isActive })
    });
    if (res.ok) loadOrgDetail();
    else alert('Failed');
}

async function changePlan(id) {
    const plan = document.getElementById('plan-select').value;
    if (!confirm(`Change plan to ${plan}?`)) return;
    const res = await fetch(`/api/v1/meta/orgs/${id}`, {
        method: 'PATCH', credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plan_id: plan })
    });
    if (res.ok) loadOrgDetail();
    else alert('Failed');
}

loadOrgDetail();
</script>
{% endblock %}
