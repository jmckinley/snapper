{% extends "base.html" %}

{% block title %}Connect Your AI - Snapper{% endblock %}

{% block header %}
<header class="bg-white shadow">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-gray-900">Connect Your AI</h1>
                <p class="mt-1 text-sm text-gray-500">Tell Snapper which AI assistants you want to protect. We'll help you set up security rules for each one.</p>
            </div>
        </div>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Getting Started Banner -->
    <div id="getting-started" class="bg-gradient-to-r from-primary-600 to-primary-700 rounded-lg shadow-lg overflow-hidden">
        <div class="px-6 py-6">
            <div class="flex items-start space-x-4">
                <div class="flex-shrink-0">
                    <div class="h-12 w-12 bg-white/20 rounded-full flex items-center justify-center">
                        <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </div>
                </div>
                <div class="text-white">
                    <h2 class="text-xl font-bold">Quick Start: Connect OpenClaw in 2 minutes</h2>
                    <p class="mt-1 text-primary-100">OpenClaw is an AI coding assistant. Once connected, Snapper will control what it can access.</p>
                    <button onclick="showOpenClawSetup()" class="mt-4 inline-flex items-center px-4 py-2 bg-white text-primary-700 font-medium rounded-md hover:bg-primary-50 transition-colors">
                        <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Connect OpenClaw
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Connected AI Services -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Your Connected AI Services</h3>
                <p class="text-sm text-gray-500">AI assistants that Snapper is protecting</p>
            </div>
            <button onclick="showRegisterModal()" class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                Add Another AI
            </button>
        </div>
        <div id="agents-list" class="divide-y divide-gray-200">
            <div class="px-6 py-8 text-center text-gray-500">
                <div class="animate-pulse">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Help Section -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">What AI services can I connect?</h3>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <div class="h-10 w-10 bg-green-100 rounded-lg flex items-center justify-center">
                            <span class="text-xl">ü¶é</span>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">OpenClaw</h4>
                            <p class="text-xs text-gray-500">AI coding assistant</p>
                        </div>
                    </div>
                </div>
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <div class="h-10 w-10 bg-purple-100 rounded-lg flex items-center justify-center">
                            <span class="text-xl">ü§ñ</span>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Claude Code</h4>
                            <p class="text-xs text-gray-500">Anthropic's coding AI</p>
                        </div>
                    </div>
                </div>
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <div class="h-10 w-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <span class="text-xl">‚ú®</span>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Cursor</h4>
                            <p class="text-xs text-gray-500">AI-powered code editor</p>
                        </div>
                    </div>
                </div>
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <div class="h-10 w-10 bg-gray-100 rounded-lg flex items-center justify-center">
                            <span class="text-xl">üöÄ</span>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">GitHub Copilot</h4>
                            <p class="text-xs text-gray-500">AI pair programmer</p>
                        </div>
                    </div>
                </div>
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <div class="h-10 w-10 bg-orange-100 rounded-lg flex items-center justify-center">
                            <span class="text-xl">üîß</span>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Custom MCP Server</h4>
                            <p class="text-xs text-gray-500">Any MCP-compatible AI</p>
                        </div>
                    </div>
                </div>
                <div class="border border-dashed border-gray-300 rounded-lg p-4 flex items-center justify-center">
                    <p class="text-sm text-gray-400">More coming soon...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- OpenClaw Setup Modal -->
<div id="openclaw-modal" class="hidden fixed z-10 inset-0 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:p-0">
        <div class="fixed inset-0 transition-opacity" onclick="hideOpenClawSetup()">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
            <div class="bg-white px-6 pt-6 pb-4">
                <div class="flex items-center space-x-4 mb-6">
                    <div class="h-14 w-14 bg-green-100 rounded-xl flex items-center justify-center">
                        <span class="text-3xl">ü¶é</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">Connect OpenClaw</h3>
                        <p class="text-sm text-gray-500">Let's get your AI assistant connected to Snapper</p>
                    </div>
                </div>

                <!-- Step 1: Platform Selection -->
                <div id="setup-step-1">
                    <h4 class="font-medium text-gray-900 mb-3">Where is OpenClaw running?</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button onclick="selectPlatform('macos')" class="platform-btn flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-all text-left">
                            <span class="text-2xl mr-3">üçé</span>
                            <div>
                                <p class="font-medium text-gray-900">macOS</p>
                                <p class="text-xs text-gray-500">Running on your Mac</p>
                            </div>
                        </button>
                        <button onclick="selectPlatform('linux')" class="platform-btn flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-all text-left">
                            <span class="text-2xl mr-3">üêß</span>
                            <div>
                                <p class="font-medium text-gray-900">Linux / Ubuntu</p>
                                <p class="text-xs text-gray-500">Local Linux machine</p>
                            </div>
                        </button>
                        <button onclick="selectPlatform('digitalocean')" class="platform-btn flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-all text-left">
                            <span class="text-2xl mr-3">üåä</span>
                            <div>
                                <p class="font-medium text-gray-900">DigitalOcean</p>
                                <p class="text-xs text-gray-500">Droplet or App Platform</p>
                            </div>
                        </button>
                        <button onclick="selectPlatform('hostinger')" class="platform-btn flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-all text-left">
                            <span class="text-2xl mr-3">üè†</span>
                            <div>
                                <p class="font-medium text-gray-900">Hostinger VPS</p>
                                <p class="text-xs text-gray-500">Hostinger virtual server</p>
                            </div>
                        </button>
                        <button onclick="selectPlatform('aws')" class="platform-btn flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-all text-left">
                            <span class="text-2xl mr-3">‚òÅÔ∏è</span>
                            <div>
                                <p class="font-medium text-gray-900">AWS / EC2</p>
                                <p class="text-xs text-gray-500">Amazon cloud server</p>
                            </div>
                        </button>
                        <button onclick="selectPlatform('docker')" class="platform-btn flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary-500 hover:bg-primary-50 transition-all text-left">
                            <span class="text-2xl mr-3">üê≥</span>
                            <div>
                                <p class="font-medium text-gray-900">Docker</p>
                                <p class="text-xs text-gray-500">Running in a container</p>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Instructions (hidden initially) -->
                <div id="setup-step-2" class="hidden">
                    <div class="flex items-center mb-4">
                        <button onclick="backToStep1()" class="text-gray-500 hover:text-gray-700 mr-3">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h4 class="font-medium text-gray-900">Setup Instructions for <span id="platform-name"></span></h4>
                    </div>

                    <div id="platform-instructions" class="bg-gray-50 rounded-lg p-4 mb-4">
                        <!-- Instructions will be inserted here -->
                    </div>

                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <h5 class="font-medium text-green-800 mb-2">Your Snapper Connection Details</h5>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center justify-between bg-white rounded px-3 py-2">
                                <span class="text-gray-600">Snapper URL:</span>
                                <code id="snapper-url" class="text-green-700 font-mono">http://localhost:8000</code>
                            </div>
                            <div class="flex items-center justify-between bg-white rounded px-3 py-2">
                                <span class="text-gray-600">Agent ID:</span>
                                <code class="text-green-700 font-mono">openclaw-main</code>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">Telegram Chat ID (optional)</label>
                        <input type="text" id="openclaw-owner-chat-id" placeholder="e.g., 123456789" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm font-mono">
                        <p class="mt-1 text-xs text-gray-500">Links this agent to your Telegram for /trust and approval routing</p>
                    </div>

                    <div class="flex items-center space-x-2 text-sm text-gray-600 mb-4">
                        <input type="checkbox" id="setup-confirmed" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        <label for="setup-confirmed">I've added the configuration to OpenClaw</label>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
                <button onclick="hideOpenClawSetup()" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900">
                    Cancel
                </button>
                <button id="setup-complete-btn" onclick="completeOpenClawSetup()" class="hidden px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700">
                    Complete Setup
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Generic Register Modal -->
<div id="register-modal" class="hidden fixed z-10 inset-0 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:p-0">
        <div class="fixed inset-0 transition-opacity" onclick="hideRegisterModal()">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form id="register-form" onsubmit="registerAgent(event)">
                <div class="bg-white px-6 pt-6 pb-4">
                    <h3 class="text-lg font-bold text-gray-900 mb-2">Connect Another AI Service</h3>
                    <p class="text-sm text-gray-500 mb-4">Add any AI assistant that supports MCP (Model Context Protocol)</p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" name="name" required placeholder="e.g., My Claude Code" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                            <p class="mt-1 text-xs text-gray-500">A friendly name to identify this AI</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Agent ID</label>
                            <input type="text" name="external_id" required placeholder="e.g., claude-code-laptop" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm font-mono">
                            <p class="mt-1 text-xs text-gray-500">This ID will be used in your AI's configuration</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Description (optional)</label>
                            <textarea name="description" rows="2" placeholder="e.g., Claude Code on my work laptop" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Telegram Chat ID (optional)</label>
                            <input type="text" name="owner_chat_id" placeholder="e.g., 123456789" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm font-mono">
                            <p class="mt-1 text-xs text-gray-500">Links this agent to your Telegram for /trust and approval routing. Send /start to @Snapper_approval_bot to get your Chat ID.</p>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
                    <button type="button" onclick="hideRegisterModal()" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-md hover:bg-primary-700">
                        Add AI Service
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedPlatform = null;

    const platformInstructions = {
        macos: {
            name: 'macOS',
            steps: `
                <ol class="list-decimal list-inside space-y-3 text-sm text-gray-700">
                    <li>Open <strong>Terminal</strong> on your Mac</li>
                    <li>Open your OpenClaw config file:
                        <pre class="bg-gray-800 text-green-400 rounded p-2 mt-2 text-xs overflow-x-auto">nano ~/.openclaw/config.yaml</pre>
                    </li>
                    <li>Add these lines to the config:
                        <pre class="bg-gray-800 text-green-400 rounded p-2 mt-2 text-xs overflow-x-auto">snapper:
  enabled: true
  url: http://localhost:8000
  agent_id: openclaw-main</pre>
                    </li>
                    <li>Save the file (Ctrl+O, then Ctrl+X)</li>
                    <li>Restart OpenClaw</li>
                </ol>
            `
        },
        linux: {
            name: 'Linux / Ubuntu',
            steps: `
                <ol class="list-decimal list-inside space-y-3 text-sm text-gray-700">
                    <li>Open a terminal window</li>
                    <li>Edit your OpenClaw config:
                        <pre class="bg-gray-800 text-green-400 rounded p-2 mt-2 text-xs overflow-x-auto">nano ~/.openclaw/config.yaml</pre>
                    </li>
                    <li>Add the Snapper configuration:
                        <pre class="bg-gray-800 text-green-400 rounded p-2 mt-2 text-xs overflow-x-auto">snapper:
  enabled: true
  url: http://localhost:8000
  agent_id: openclaw-main</pre>
                    </li>
                    <li>Save and exit (Ctrl+O, Ctrl+X)</li>
                    <li>Restart OpenClaw: <code class="bg-gray-200 px-1 rounded">systemctl restart openclaw</code></li>
                </ol>
            `
        },
        digitalocean: {
            name: 'DigitalOcean',
            steps: `
                <ol class="list-decimal list-inside space-y-3 text-sm text-gray-700">
                    <li>SSH into your Droplet:
                        <pre class="bg-gray-800 text-green-400 rounded p-2 mt-2 text-xs overflow-x-auto">ssh root@your-droplet-ip</pre>
                    </li>
                    <li>Edit the OpenClaw config:
                        <pre class="bg-gray-800 text-green-400 rounded p-2 mt-2 text-xs overflow-x-auto">nano /etc/openclaw/config.yaml</pre>
                    </li>
                    <li>Add Snapper configuration (use your Droplet's IP for the URL if Snapper is remote):
                        <pre class="bg-gray-800 text-green-400 rounded p-2 mt-2 text-xs overflow-x-auto">snapper:
  enabled: true
  url: http://YOUR_SNAPPER_IP:8000
  agent_id: openclaw-main</pre>
                    </li>
                    <li>Restart: <code class="bg-gray-200 px-1 rounded">systemctl restart openclaw</code></li>
                </ol>
                <div class="mt-3 p-3 bg-blue-50 rounded-lg text-xs text-blue-800">
                    <strong>Tip:</strong> Make sure port 8000 is open in your firewall if Snapper runs on a different server.
                </div>
            `
        },
        hostinger: {
            name: 'Hostinger VPS',
            steps: `
                <ol class="list-decimal list-inside space-y-3 text-sm text-gray-700">
                    <li>Log into your Hostinger VPS via SSH or the browser terminal</li>
                    <li>Navigate to OpenClaw's config directory:
                        <pre class="bg-gray-800 text-green-400 rounded p-2 mt-2 text-xs overflow-x-auto">cd /etc/openclaw</pre>
                    </li>
                    <li>Edit the config file:
                        <pre class="bg-gray-800 text-green-400 rounded p-2 mt-2 text-xs overflow-x-auto">nano config.yaml</pre>
                    </li>
                    <li>Add:
                        <pre class="bg-gray-800 text-green-400 rounded p-2 mt-2 text-xs overflow-x-auto">snapper:
  enabled: true
  url: http://YOUR_SNAPPER_IP:8000
  agent_id: openclaw-main</pre>
                    </li>
                    <li>Restart OpenClaw</li>
                </ol>
            `
        },
        aws: {
            name: 'AWS / EC2',
            steps: `
                <ol class="list-decimal list-inside space-y-3 text-sm text-gray-700">
                    <li>SSH into your EC2 instance:
                        <pre class="bg-gray-800 text-green-400 rounded p-2 mt-2 text-xs overflow-x-auto">ssh -i your-key.pem ec2-user@your-instance-ip</pre>
                    </li>
                    <li>Edit OpenClaw config:
                        <pre class="bg-gray-800 text-green-400 rounded p-2 mt-2 text-xs overflow-x-auto">sudo nano /etc/openclaw/config.yaml</pre>
                    </li>
                    <li>Add Snapper settings:
                        <pre class="bg-gray-800 text-green-400 rounded p-2 mt-2 text-xs overflow-x-auto">snapper:
  enabled: true
  url: http://YOUR_SNAPPER_IP:8000
  agent_id: openclaw-main</pre>
                    </li>
                    <li>Restart: <code class="bg-gray-200 px-1 rounded">sudo systemctl restart openclaw</code></li>
                </ol>
                <div class="mt-3 p-3 bg-yellow-50 rounded-lg text-xs text-yellow-800">
                    <strong>Security:</strong> Update your Security Group to allow inbound traffic on port 8000 from your Snapper server.
                </div>
            `
        },
        docker: {
            name: 'Docker',
            steps: `
                <ol class="list-decimal list-inside space-y-3 text-sm text-gray-700">
                    <li>Add environment variables to your Docker run command or docker-compose.yml:
                        <pre class="bg-gray-800 text-green-400 rounded p-2 mt-2 text-xs overflow-x-auto">docker run -e SNAPPER_URL=http://host.docker.internal:8000 \\
  -e SNAPPER_AGENT_ID=openclaw-main \\
  -e SNAPPER_ENABLED=true \\
  openclaw/openclaw</pre>
                    </li>
                    <li>Or in docker-compose.yml:
                        <pre class="bg-gray-800 text-green-400 rounded p-2 mt-2 text-xs overflow-x-auto">services:
  openclaw:
    image: openclaw/openclaw
    environment:
      - SNAPPER_URL=http://host.docker.internal:8000
      - SNAPPER_AGENT_ID=openclaw-main
      - SNAPPER_ENABLED=true</pre>
                    </li>
                    <li>Restart your container</li>
                </ol>
                <div class="mt-3 p-3 bg-blue-50 rounded-lg text-xs text-blue-800">
                    <strong>Note:</strong> Use <code>host.docker.internal</code> if Snapper runs on your host machine, or the actual IP/hostname if it's elsewhere.
                </div>
            `
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        loadAgents();

        // Show/hide complete button based on checkbox
        document.getElementById('setup-confirmed')?.addEventListener('change', (e) => {
            document.getElementById('setup-complete-btn').classList.toggle('hidden', !e.target.checked);
        });
    });

    async function loadAgents() {
        try {
            const response = await fetch('/api/v1/agents?page_size=50');
            const data = await response.json();
            renderAgents(data.items);

            // Hide getting started if OpenClaw is already connected
            const hasOpenClaw = data.items.some(a => a.external_id === 'openclaw-main');
            if (hasOpenClaw) {
                document.getElementById('getting-started').classList.add('hidden');
            }
        } catch (error) {
            console.error('Failed to load agents:', error);
        }
    }

    function getAgentActivity(agent) {
        // Determine real connection status from last_seen_at
        if (agent.status !== 'active') {
            if (agent.status === 'pending') return { label: '‚óã Pending', bg: 'bg-yellow-100 text-yellow-800' };
            if (agent.status === 'suspended') return { label: '‚è∏ Paused', bg: 'bg-gray-100 text-gray-800' };
            if (agent.status === 'quarantined') return { label: '‚õî Quarantined', bg: 'bg-red-100 text-red-800' };
            return { label: agent.status, bg: 'bg-gray-100 text-gray-800' };
        }
        const lastSeen = agent.last_seen_at ? new Date(agent.last_seen_at) : null;
        if (!lastSeen) {
            return { label: '‚óã Never seen', bg: 'bg-yellow-100 text-yellow-800' };
        }
        const minutesAgo = (Date.now() - lastSeen.getTime()) / 60000;
        if (minutesAgo < 60) {
            return { label: '‚óè Connected', bg: 'bg-green-100 text-green-800' };
        } else if (minutesAgo < 1440) {
            const hrs = Math.floor(minutesAgo / 60);
            return { label: `‚óã ${hrs}h ago`, bg: 'bg-blue-100 text-blue-800' };
        } else {
            const days = Math.floor(minutesAgo / 1440);
            return { label: `‚óã ${days}d ago`, bg: 'bg-gray-100 text-gray-600' };
        }
    }

    function renderAgents(agents) {
        const container = document.getElementById('agents-list');

        if (agents.length === 0) {
            container.innerHTML = `
                <div class="px-6 py-12 text-center">
                    <div class="text-4xl mb-4">üîå</div>
                    <h4 class="text-lg font-medium text-gray-900 mb-2">No AI services connected yet</h4>
                    <p class="text-gray-500 mb-4">Click "Connect OpenClaw" above to get started</p>
                </div>
            `;
            return;
        }

        container.innerHTML = agents.map(agent => `
            <div class="px-6 py-4 hover:bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="h-10 w-10 ${agent.status === 'active' && agent.last_seen_at && (Date.now() - new Date(agent.last_seen_at).getTime()) < 3600000 ? 'bg-green-100' : agent.status === 'active' ? 'bg-blue-100' : 'bg-gray-100'} rounded-full flex items-center justify-center">
                            ${agent.external_id.includes('openclaw') ? 'ü¶é' : 'ü§ñ'}
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">${agent.name}</h4>
                            <p class="text-sm text-gray-500">ID: <code class="bg-gray-100 px-1 rounded">${agent.external_id}</code></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        ${(() => { const a = getAgentActivity(agent); return `
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${a.bg}">
                            ${a.label}
                        </span>`; })()}
                        <div class="flex space-x-2">
                            <button onclick="resetTrust('${agent.id}')" class="text-sm text-blue-600 hover:text-blue-700">Reset Trust</button>
                            <button onclick="toggleTrust('${agent.id}', ${agent.auto_adjust_trust})" class="text-sm ${agent.auto_adjust_trust ? 'text-orange-600 hover:text-orange-700' : 'text-gray-500 hover:text-gray-700'}">${agent.auto_adjust_trust ? 'Trust: On' : 'Trust: Off'}</button>
                            ${agent.status === 'active' ?
                                `<button onclick="suspendAgent('${agent.id}')" class="text-sm text-yellow-600 hover:text-yellow-700">Pause</button>` :
                                `<button onclick="activateAgent('${agent.id}')" class="text-sm text-green-600 hover:text-green-700">Activate</button>`
                            }
                        </div>
                    </div>
                </div>
                <!-- API Key Section -->
                <div class="mt-3 ml-14 p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <span class="text-xs font-medium text-gray-500 uppercase">API Key</span>
                            <code id="key-display-${agent.id}" class="text-sm font-mono bg-white px-2 py-1 rounded border">${maskApiKey(agent.api_key)}</code>
                            <input type="hidden" id="key-full-${agent.id}" value="${agent.api_key || ''}">
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="toggleKeyVisibility('${agent.id}')" class="text-xs px-2 py-1 text-gray-600 hover:text-gray-800 border border-gray-300 rounded hover:bg-gray-100" title="Show/hide key">
                                <span id="key-toggle-${agent.id}">Show</span>
                            </button>
                            <button onclick="copyApiKey('${agent.id}')" class="text-xs px-2 py-1 text-primary-600 hover:text-primary-800 border border-primary-300 rounded hover:bg-primary-50" title="Copy to clipboard">
                                Copy
                            </button>
                            <button onclick="regenerateApiKey('${agent.id}')" class="text-xs px-2 py-1 text-orange-600 hover:text-orange-800 border border-orange-300 rounded hover:bg-orange-50" title="Generate new key">
                                Regenerate
                            </button>
                        </div>
                    </div>
                    <p class="mt-2 text-xs text-gray-500">Use this key in X-API-Key header when calling Snapper from this agent</p>
                </div>
            </div>
        `).join('');
    }

    function showOpenClawSetup() {
        document.getElementById('openclaw-modal').classList.remove('hidden');
        document.getElementById('setup-step-1').classList.remove('hidden');
        document.getElementById('setup-step-2').classList.add('hidden');
    }

    function hideOpenClawSetup() {
        document.getElementById('openclaw-modal').classList.add('hidden');
    }

    function selectPlatform(platform) {
        selectedPlatform = platform;
        const info = platformInstructions[platform];

        document.getElementById('platform-name').textContent = info.name;
        document.getElementById('platform-instructions').innerHTML = info.steps;

        // Update Snapper URL based on platform
        const snapperUrl = document.getElementById('snapper-url');
        if (['digitalocean', 'hostinger', 'aws'].includes(platform)) {
            snapperUrl.textContent = 'http://YOUR_SNAPPER_IP:8000';
        } else if (platform === 'docker') {
            snapperUrl.textContent = 'http://host.docker.internal:8000';
        } else {
            snapperUrl.textContent = 'http://localhost:8000';
        }

        document.getElementById('setup-step-1').classList.add('hidden');
        document.getElementById('setup-step-2').classList.remove('hidden');
        document.getElementById('setup-complete-btn').classList.add('hidden');
        document.getElementById('setup-confirmed').checked = false;
    }

    function backToStep1() {
        document.getElementById('setup-step-1').classList.remove('hidden');
        document.getElementById('setup-step-2').classList.add('hidden');
    }

    async function completeOpenClawSetup() {
        try {
            const ownerChatId = document.getElementById('openclaw-owner-chat-id')?.value?.trim();
            const agentData = {
                name: 'OpenClaw',
                external_id: 'openclaw-main',
                description: `OpenClaw instance (${platformInstructions[selectedPlatform].name})`,
                trust_level: 'standard',
                status: 'active'
            };
            if (ownerChatId) agentData.owner_chat_id = ownerChatId;

            const response = await fetch('/api/v1/agents', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(agentData)
            });

            if (response.ok) {
                hideOpenClawSetup();
                loadAgents();
                showToast('OpenClaw connected successfully!', 'success');
            } else {
                const error = await response.json();
                if (error.detail?.includes('already exists')) {
                    showToast('OpenClaw is already connected', 'info');
                    hideOpenClawSetup();
                } else {
                    showToast(error.detail || 'Failed to connect', 'error');
                }
            }
        } catch (error) {
            showToast('Connection failed', 'error');
        }
    }

    function showRegisterModal() {
        document.getElementById('register-modal').classList.remove('hidden');
    }

    function hideRegisterModal() {
        document.getElementById('register-modal').classList.add('hidden');
    }

    async function registerAgent(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        try {
            const response = await fetch('/api/v1/agents', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: formData.get('name'),
                    external_id: formData.get('external_id'),
                    description: formData.get('description'),
                    trust_level: 'standard',
                    owner_chat_id: formData.get('owner_chat_id') || undefined
                })
            });

            if (response.ok) {
                hideRegisterModal();
                form.reset();
                loadAgents();
                showToast('AI service added!', 'success');
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to add', 'error');
            }
        } catch (error) {
            showToast('Failed to add AI service', 'error');
        }
    }

    async function resetTrust(id) {
        if (!confirm('Reset this agent\'s trust score to 1.0?')) return;
        try {
            const resp = await fetch(`/api/v1/agents/${id}/reset-trust`, { method: 'POST' });
            if (resp.ok) {
                showToast('Trust score reset to 1.0', 'success');
                loadAgents();
            } else {
                showToast('Failed to reset trust', 'error');
            }
        } catch (error) {
            showToast('Failed to reset trust', 'error');
        }
    }

    async function toggleTrust(id, currentValue) {
        const action = currentValue ? 'disable' : 'enable';
        const desc = currentValue
            ? 'Disable trust enforcement? Score will be tracked but won\'t affect rate limits.'
            : 'Enable trust enforcement? Score will actively scale rate limits.';
        if (!confirm(desc)) return;
        try {
            const resp = await fetch(`/api/v1/agents/${id}/toggle-trust`, { method: 'POST' });
            if (resp.ok) {
                showToast(`Trust enforcement ${action}d`, 'success');
                loadAgents();
            } else {
                showToast(`Failed to ${action} trust`, 'error');
            }
        } catch (error) {
            showToast(`Failed to ${action} trust`, 'error');
        }
    }

    async function suspendAgent(id) {
        if (!confirm('Pause this AI service? Snapper will stop protecting it.')) return;
        try {
            await fetch(`/api/v1/agents/${id}/suspend`, { method: 'POST' });
            loadAgents();
        } catch (error) {
            showToast('Failed to pause', 'error');
        }
    }

    async function activateAgent(id) {
        try {
            await fetch(`/api/v1/agents/${id}/activate`, { method: 'POST' });
            loadAgents();
        } catch (error) {
            showToast('Failed to activate', 'error');
        }
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        toast.className = `${bgColor} text-white px-4 py-2 rounded-lg shadow-lg`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // API Key Management Functions
    function maskApiKey(key) {
        if (!key) return 'No key';
        // Show prefix and last 4 chars: snp_****abcd
        if (key.length > 12) {
            return key.substring(0, 4) + '****' + key.substring(key.length - 4);
        }
        return key.substring(0, 4) + '****';
    }

    function toggleKeyVisibility(agentId) {
        const display = document.getElementById(`key-display-${agentId}`);
        const fullKey = document.getElementById(`key-full-${agentId}`).value;
        const toggle = document.getElementById(`key-toggle-${agentId}`);

        if (toggle.textContent === 'Show') {
            display.textContent = fullKey;
            toggle.textContent = 'Hide';
        } else {
            display.textContent = maskApiKey(fullKey);
            toggle.textContent = 'Show';
        }
    }

    async function copyApiKey(agentId) {
        const fullKey = document.getElementById(`key-full-${agentId}`).value;
        try {
            await navigator.clipboard.writeText(fullKey);
            showToast('API key copied to clipboard', 'success');
        } catch (err) {
            // Fallback for older browsers
            const textarea = document.createElement('textarea');
            textarea.value = fullKey;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('API key copied', 'success');
        }
    }

    async function regenerateApiKey(agentId) {
        if (!confirm('Generate a new API key? The old key will stop working immediately.')) return;

        try {
            const response = await fetch(`/api/v1/agents/${agentId}/regenerate-key`, {
                method: 'POST'
            });

            if (response.ok) {
                const data = await response.json();
                // Update the displayed key
                document.getElementById(`key-full-${agentId}`).value = data.api_key;
                document.getElementById(`key-display-${agentId}`).textContent = data.api_key;
                document.getElementById(`key-toggle-${agentId}`).textContent = 'Hide';
                showToast('New API key generated!', 'success');
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to regenerate key', 'error');
            }
        } catch (error) {
            showToast('Failed to regenerate key', 'error');
        }
    }
</script>
{% endblock %}
