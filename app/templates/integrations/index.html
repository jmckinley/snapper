{% extends "base.html" %}

{% block title %}Rules & Traffic - Snapper{% endblock %}

{% block header %}
<header class="bg-white shadow">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-gray-900">Rules & Traffic</h1>
                <p class="mt-1 text-sm text-gray-500">Discover what your agents are doing and create rules from live traffic</p>
            </div>
            <div class="flex items-center space-x-4">
                <span id="enabled-count" class="text-sm text-gray-500">0 templates active</span>
                <span class="text-gray-300">|</span>
                <span id="rules-count" class="text-sm text-gray-500">0 rules active</span>
            </div>
        </div>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="space-y-6">

    <!-- ================================================================== -->
    <!-- SECTION 1: Discovered Activity                                     -->
    <!-- ================================================================== -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex flex-wrap justify-between items-center gap-3">
            <div class="flex items-center space-x-3">
                <span class="text-2xl">ðŸ“¡</span>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Discovered Activity</h2>
                    <p class="text-sm text-gray-500">MCP servers and tools detected from live agent traffic</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <!-- Period selector -->
                <select id="period-select" onchange="loadTrafficInsights()"
                        class="text-sm border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
                    <option value="24">Last 24 hours</option>
                    <option value="168" selected>Last 7 days</option>
                    <option value="720">Last 30 days</option>
                </select>
                <button onclick="loadTrafficInsights()" class="text-sm text-primary-600 hover:text-primary-700">
                    <svg class="w-4 h-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Traffic summary bar -->
        <div id="traffic-summary" class="px-6 py-3 bg-gray-50 border-b border-gray-200 hidden">
            <div class="flex items-center space-x-6 text-sm">
                <span><strong id="ts-evals">0</strong> evaluations</span>
                <span><strong id="ts-commands">0</strong> unique commands</span>
                <span class="text-green-600"><strong id="ts-covered">0</strong> covered</span>
                <span class="text-red-600"><strong id="ts-uncovered">0</strong> uncovered</span>
            </div>
        </div>

        <div id="traffic-container" class="divide-y divide-gray-100">
            <div class="px-6 py-12 text-center text-gray-400">
                <div class="text-4xl mb-3">ðŸ“¡</div>
                <p>Loading traffic data...</p>
            </div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- SECTION 2: Add MCP Server (manual)                                 -->
    <!-- ================================================================== -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center space-x-3">
                <span class="text-2xl">ðŸ”§</span>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Add MCP Server</h2>
                    <p class="text-sm text-gray-500">Create smart default rules for any MCP server â€” known or custom</p>
                </div>
            </div>
        </div>
        <div class="px-6 py-4">
            <div class="flex items-end gap-3">
                <div class="flex-1 max-w-sm">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Server name</label>
                    <input type="text" id="add-server-name" placeholder="e.g. notion, linear, google-calendar"
                           list="known-servers-list"
                           class="w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 text-sm">
                    <datalist id="known-servers-list"></datalist>
                </div>
                <button onclick="addMCPServer()" id="add-server-btn"
                        class="px-4 py-2 bg-primary-600 text-white text-sm rounded-md hover:bg-primary-700 transition-colors">
                    Create Rules
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-2">Creates 3 rules: allow reads, approve writes, block destructive ops. Patterns match both <code>mcp__server__tool</code> and <code>server_tool</code> formats.</p>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- SECTION 3: Rule Templates                                          -->
    <!-- ================================================================== -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center space-x-3">
                <span class="text-2xl">ðŸ“‹</span>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Rule Templates</h2>
                    <p class="text-sm text-gray-500">Pre-built security rules with patterns matching real MCP tool names</p>
                </div>
            </div>
        </div>
        <div id="integrations-container" class="divide-y divide-gray-100">
            <div class="animate-pulse space-y-4 p-6">
                <div class="h-8 bg-gray-200 rounded w-1/4"></div>
                <div class="h-20 bg-gray-200 rounded"></div>
                <div class="h-20 bg-gray-200 rounded"></div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    let integrationData = [];
    let integrationDetails = {};
    let expandedIntegration = null;
    let selectedRules = new Set();
    let trafficData = null;

    document.addEventListener('DOMContentLoaded', () => {
        loadTrafficInsights();
        loadIntegrations();
        loadKnownServers();
    });

    // =====================================================================
    // Traffic Insights
    // =====================================================================

    async function loadTrafficInsights() {
        const hours = document.getElementById('period-select').value;
        const container = document.getElementById('traffic-container');

        try {
            const response = await fetch(`/api/v1/integrations/traffic/insights?hours=${hours}`);
            trafficData = await response.json();
            renderTrafficInsights(trafficData);
        } catch (error) {
            console.error('Failed to load traffic:', error);
            container.innerHTML = `<div class="px-6 py-8 text-center text-red-500 text-sm">Failed to load traffic data.</div>`;
        }
    }

    function renderTrafficInsights(data) {
        const container = document.getElementById('traffic-container');
        const summary = document.getElementById('traffic-summary');

        // Update summary bar
        document.getElementById('ts-evals').textContent = data.total_evaluations;
        document.getElementById('ts-commands').textContent = data.total_unique_commands;
        document.getElementById('ts-covered').textContent = data.total_unique_commands - data.total_uncovered;
        document.getElementById('ts-uncovered').textContent = data.total_uncovered;
        summary.classList.remove('hidden');

        if (!data.service_groups || data.service_groups.length === 0) {
            container.innerHTML = `
                <div class="px-6 py-12 text-center">
                    <div class="text-4xl mb-3">ðŸ“¡</div>
                    <p class="text-gray-500 font-medium">No agent traffic recorded yet</p>
                    <p class="text-sm text-gray-400 mt-1">Activity will appear here once agents start sending requests through Snapper</p>
                </div>
            `;
            return;
        }

        container.innerHTML = data.service_groups.map(group => {
            const coverageBadge = group.uncovered_count > 0
                ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">${group.uncovered_count} uncovered</span>`
                : `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">fully covered</span>`;

            const templateBtn = group.has_template && group.template_id
                ? `<button onclick="event.stopPropagation(); toggleIntegrationExpand('${group.template_id}')"
                          class="text-xs px-2 py-1 bg-primary-100 text-primary-700 rounded hover:bg-primary-200">Enable Template</button>`
                : group.source_type === 'mcp' || group.source_type === 'unknown'
                    ? `<button onclick="event.stopPropagation(); addServerFromGroup('${group.server_key}')"
                              class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Add Rules</button>`
                    : '';

            const commandRows = group.commands.map(cmd => {
                const covered = cmd.has_matching_rule;
                const decisionBadges = Object.entries(cmd.decisions).map(([k, v]) => {
                    const color = k === 'allow' ? 'green' : k === 'deny' ? 'red' : 'yellow';
                    return `<span class="text-xs text-${color}-600">${v} ${k}</span>`;
                }).join(' Â· ');

                return `
                    <div class="pl-12 pr-6 py-2 flex items-center justify-between text-sm ${covered ? '' : 'bg-red-50/50'}">
                        <div class="flex items-center gap-2 min-w-0 flex-1">
                            <span class="w-1.5 h-1.5 rounded-full ${covered ? 'bg-green-400' : 'bg-red-400'}"></span>
                            <code class="text-xs bg-gray-100 px-1.5 py-0.5 rounded truncate max-w-md">${escapeHtml(cmd.command)}</code>
                            <span class="text-xs text-gray-400">${cmd.count}x</span>
                            <span class="text-xs text-gray-400">${decisionBadges}</span>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            ${covered
                                ? `<span class="text-xs text-green-600" title="${escapeHtml(cmd.matching_rule_names.join(', '))}">âœ“ covered</span>`
                                : `<button onclick="event.stopPropagation(); openCreateRuleModal('${escapeHtml(cmd.command)}')"
                                          class="text-xs px-2 py-1 bg-primary-600 text-white rounded hover:bg-primary-700">Create Rule</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="traffic-group">
                    <div class="px-6 py-3 cursor-pointer hover:bg-gray-50 transition-colors"
                         onclick="toggleTrafficGroup(this)">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${group.icon}</span>
                                <div>
                                    <span class="font-medium text-gray-900">${escapeHtml(group.display_name)}</span>
                                    <span class="text-xs text-gray-400 ml-2">${group.total_count} calls Â· ${group.commands.length} tools</span>
                                </div>
                                ${coverageBadge}
                            </div>
                            <div class="flex items-center gap-3">
                                ${templateBtn}
                                <svg class="w-4 h-4 text-gray-400 transition-transform traffic-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="traffic-commands hidden border-t border-gray-100">
                        ${commandRows}
                    </div>
                </div>
            `;
        }).join('');
    }

    function toggleTrafficGroup(header) {
        const commands = header.nextElementSibling;
        const chevron = header.querySelector('.traffic-chevron');
        commands.classList.toggle('hidden');
        chevron.classList.toggle('rotate-180');
    }

    function addServerFromGroup(serverKey) {
        document.getElementById('add-server-name').value = serverKey;
        document.getElementById('add-server-name').scrollIntoView({ behavior: 'smooth' });
        document.getElementById('add-server-name').focus();
    }

    // =====================================================================
    // Create Rule Modal (inline)
    // =====================================================================

    function openCreateRuleModal(command) {
        const action = prompt(
            `Create rule for: ${command}\n\nChoose action:\n1 = allow\n2 = require_approval\n3 = deny\n\nEnter 1, 2, or 3:`,
            '1'
        );
        if (!action) return;

        const actionMap = { '1': 'allow', '2': 'require_approval', '3': 'deny' };
        const selectedAction = actionMap[action] || 'allow';

        createRuleFromTraffic(command, selectedAction);
    }

    async function createRuleFromTraffic(command, action) {
        try {
            const response = await fetch('/api/v1/integrations/traffic/create-rule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command, action, pattern_mode: 'prefix' }),
            });
            if (!response.ok) throw new Error((await response.json()).detail || 'Failed');
            const result = await response.json();
            showToast(`Created rule: ${result.name}`, 'success');
            loadTrafficInsights();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    // =====================================================================
    // Add MCP Server
    // =====================================================================

    async function addMCPServer() {
        const name = document.getElementById('add-server-name').value.trim();
        if (!name) { showToast('Enter a server name', 'error'); return; }

        const btn = document.getElementById('add-server-btn');
        btn.disabled = true;
        btn.textContent = 'Creating...';

        try {
            const response = await fetch('/api/v1/integrations/traffic/create-server-rules', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ server_name: name }),
            });
            if (!response.ok) throw new Error((await response.json()).detail || 'Failed');
            const result = await response.json();
            showToast(`Created ${result.rules_created} rules for ${name}`, 'success');
            document.getElementById('add-server-name').value = '';
            loadTrafficInsights();
        } catch (error) {
            showToast(error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Create Rules';
        }
    }

    async function loadKnownServers() {
        try {
            const response = await fetch('/api/v1/integrations/traffic/known-servers');
            const servers = await response.json();
            const datalist = document.getElementById('known-servers-list');
            datalist.innerHTML = servers.flatMap(s =>
                s.keys.map(k => `<option value="${k}">${s.icon} ${s.display}</option>`)
            ).join('');
        } catch (e) {
            console.warn('Could not load known servers');
        }
    }

    // =====================================================================
    // Integration Templates (same as before, simplified)
    // =====================================================================

    async function loadIntegrations() {
        try {
            const response = await fetch('/api/v1/integrations');
            integrationData = await response.json();
            renderIntegrations(integrationData);
            await updateStats();
        } catch (error) {
            console.error('Failed to load integrations:', error);
            document.getElementById('integrations-container').innerHTML = `
                <div class="text-center py-12 text-red-500">Failed to load templates.</div>
            `;
        }
    }

    function renderIntegrations(categories) {
        const container = document.getElementById('integrations-container');
        if (!categories.length) {
            container.innerHTML = '<div class="text-center py-12 text-gray-500">No templates available.</div>';
            return;
        }

        container.innerHTML = categories.map(category => `
            <div>
                <div class="px-6 py-3 border-b border-gray-200 bg-gray-50">
                    <div class="flex items-center">
                        <span class="text-xl mr-2">${category.icon}</span>
                        <span class="font-semibold text-gray-700">${category.name}</span>
                        <span class="text-xs text-gray-400 ml-2">${category.description}</span>
                    </div>
                </div>
                <div class="divide-y divide-gray-100">
                    ${category.integrations.map(i => renderIntegrationRow(i)).join('')}
                </div>
            </div>
        `).join('');
    }

    function renderIntegrationRow(integration) {
        const isExpanded = expandedIntegration === integration.id;
        const statusBadge = integration.enabled
            ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">${integration.rule_count} active</span>`
            : `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">Disabled</span>`;

        return `
            <div id="integration-${integration.id}" class="${isExpanded ? 'bg-gray-50' : ''}">
                <div class="px-6 py-3 cursor-pointer hover:bg-gray-50 transition-colors"
                     onclick="toggleIntegrationExpand('${integration.id}')">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">${integration.icon}</span>
                            <div>
                                <span class="font-medium text-gray-900">${integration.name}</span>
                                <span class="ml-2">${statusBadge}</span>
                            </div>
                        </div>
                        <svg class="w-4 h-4 text-gray-400 transform transition-transform ${isExpanded ? 'rotate-180' : ''}"
                             fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <p class="text-xs text-gray-500 mt-0.5 ml-9">${integration.description}</p>
                </div>
                <div id="rules-${integration.id}" class="${isExpanded ? '' : 'hidden'}">
                    <div class="px-6 pb-4">
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                            <div class="px-4 py-2 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                                <code class="text-xs text-gray-500">${integration.mcp_matcher}</code>
                                <div id="actions-${integration.id}" class="flex items-center space-x-2"></div>
                            </div>
                            <div id="rules-list-${integration.id}" class="divide-y divide-gray-100">
                                <div class="px-4 py-4 text-center text-gray-500 text-sm">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    async function toggleIntegrationExpand(integrationId) {
        const wasExpanded = expandedIntegration === integrationId;
        if (expandedIntegration) {
            document.getElementById(`rules-${expandedIntegration}`)?.classList.add('hidden');
            document.getElementById(`integration-${expandedIntegration}`)?.classList.remove('bg-gray-50');
        }
        if (wasExpanded) { expandedIntegration = null; return; }

        expandedIntegration = integrationId;
        const rulesSection = document.getElementById(`rules-${integrationId}`);
        const row = document.getElementById(`integration-${integrationId}`);
        if (rulesSection) {
            rulesSection.classList.remove('hidden');
            row?.classList.add('bg-gray-50');
            if (!integrationDetails[integrationId]) {
                await loadIntegrationDetails(integrationId);
            } else {
                renderRulesForIntegration(integrationId);
            }
        }
    }

    async function loadIntegrationDetails(integrationId) {
        try {
            const response = await fetch(`/api/v1/integrations/${integrationId}`);
            const details = await response.json();
            integrationDetails[integrationId] = details;
            selectedRules = new Set();
            details.rules.forEach(rule => {
                if (details.enabled && rule.enabled) selectedRules.add(rule.id);
                else if (!details.enabled && rule.default_enabled !== false) selectedRules.add(rule.id);
            });
            renderRulesForIntegration(integrationId);
        } catch (error) {
            document.getElementById(`rules-list-${integrationId}`).innerHTML =
                `<div class="px-4 py-4 text-center text-red-500 text-sm">Failed to load rules.</div>`;
        }
    }

    function renderRulesForIntegration(integrationId) {
        const details = integrationDetails[integrationId];
        if (!details) return;
        const rulesList = document.getElementById(`rules-list-${integrationId}`);
        const actionsDiv = document.getElementById(`actions-${integrationId}`);

        if (details.custom && !details.enabled) {
            // Custom MCP â€” show server name input inline
            actionsDiv.innerHTML = `
                <input type="text" id="custom-server-${integrationId}" placeholder="server name"
                       class="text-xs border-gray-300 rounded px-2 py-1 w-32">
                <button onclick="enableCustomMCP('${integrationId}')"
                        class="text-xs px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Create</button>
            `;
            rulesList.innerHTML = `<div class="px-4 py-4 text-sm text-gray-500">Enter a server name to auto-generate rules.</div>`;
            return;
        }

        if (details.enabled) {
            actionsDiv.innerHTML = `
                <button onclick="disableIntegration('${integrationId}')"
                        class="text-xs px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">Disable All</button>
            `;
        } else {
            actionsDiv.innerHTML = `
                <button onclick="enableIntegration('${integrationId}')"
                        class="text-xs px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Enable All</button>
            `;
        }

        if (details.enabled && details.existing_rules && details.existing_rules.length > 0) {
            rulesList.innerHTML = details.existing_rules.map(rule => renderActiveRuleRow(rule, details)).join('');
        } else if (!details.rules || details.rules.length === 0) {
            rulesList.innerHTML = `<div class="px-4 py-4 text-center text-gray-500 text-sm">No rules defined.</div>`;
        } else {
            rulesList.innerHTML = details.rules.map(rule => renderRuleRow(rule, details)).join('');
        }
    }

    function renderActiveRuleRow(rule, integration) {
        const actionColor = rule.action === 'allow' ? 'green' : rule.action === 'deny' ? 'red' : 'yellow';
        const ruleName = rule.name.replace(integration.name + ' - ', '');
        const patterns = rule.parameters?.patterns || [];
        const patternsHtml = patterns.slice(0, 3).map(p =>
            `<code class="text-xs bg-gray-100 px-1 rounded text-gray-500">${escapeHtml(p)}</code>`
        ).join(' ');

        return `
            <div class="px-4 py-2 bg-green-50/50 hover:bg-gray-50 transition-colors">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                        <span class="font-medium text-sm text-gray-900">${escapeHtml(ruleName)}</span>
                    </div>
                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-${actionColor}-100 text-${actionColor}-700">${rule.action.replace('_', ' ')}</span>
                </div>
                ${patterns.length > 0 ? `<div class="mt-1 ml-4 flex flex-wrap gap-1">${patternsHtml}</div>` : ''}
            </div>
        `;
    }

    function renderRuleRow(rule, integration) {
        const actionColor = rule.action === 'allow' ? 'green' : rule.action === 'deny' ? 'red' : 'yellow';
        const patterns = rule.parameters?.patterns || [];
        const patternsHtml = patterns.slice(0, 3).map(p =>
            `<code class="text-xs bg-gray-100 px-1 rounded text-gray-500">${escapeHtml(p)}</code>`
        ).join(' ');
        const ruleName = rule.name.replace(integration.name + ' - ', '');

        return `
            <div class="px-4 py-2 hover:bg-gray-50 transition-colors">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-gray-300 rounded-full"></span>
                        <span class="font-medium text-sm text-gray-900">${escapeHtml(ruleName)}</span>
                    </div>
                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-${actionColor}-100 text-${actionColor}-700">${rule.action.replace('_', ' ')}</span>
                </div>
                ${rule.description ? `<p class="text-xs text-gray-500 mt-0.5 ml-4">${escapeHtml(rule.description)}</p>` : ''}
                ${patterns.length > 0 ? `<div class="mt-1 ml-4 flex flex-wrap gap-1">${patternsHtml}</div>` : ''}
            </div>
        `;
    }

    async function enableCustomMCP(integrationId) {
        const serverName = document.getElementById(`custom-server-${integrationId}`)?.value?.trim();
        if (!serverName) { showToast('Enter a server name', 'error'); return; }

        try {
            const response = await fetch(`/api/v1/integrations/${integrationId}/enable`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ custom_server_name: serverName }),
            });
            if (!response.ok) throw new Error((await response.json()).detail || 'Failed');
            const result = await response.json();
            showToast(result.message, 'success');
            delete integrationDetails[integrationId];
            await loadIntegrations();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    async function enableIntegration(integrationId) {
        try {
            const response = await fetch(`/api/v1/integrations/${integrationId}/enable`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({}),
            });
            if (!response.ok) throw new Error((await response.json()).detail || 'Failed');
            const result = await response.json();
            showToast(result.message, 'success');
            delete integrationDetails[integrationId];
            await loadIntegrations();
            setTimeout(() => toggleIntegrationExpand(integrationId), 100);
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    async function disableIntegration(integrationId) {
        if (!confirm('Disable this integration and deactivate all its rules?')) return;
        try {
            const response = await fetch(`/api/v1/integrations/${integrationId}/disable`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            });
            if (!response.ok) throw new Error((await response.json()).detail || 'Failed');
            const result = await response.json();
            showToast(result.message, 'success');
            delete integrationDetails[integrationId];
            await loadIntegrations();
            setTimeout(() => toggleIntegrationExpand(integrationId), 100);
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    // =====================================================================
    // Stats & utilities
    // =====================================================================

    async function updateStats() {
        let total = 0, enabled = 0, integrationRules = 0;
        integrationData.forEach(cat => cat.integrations.forEach(i => {
            total++;
            if (i.enabled) { enabled++; integrationRules += i.rule_count; }
        }));
        document.getElementById('enabled-count').textContent = `${enabled} templates active`;

        let totalRules = integrationRules;
        try {
            const r = await fetch('/api/v1/rules?is_active=true');
            if (r.ok) { const d = await r.json(); totalRules = Array.isArray(d) ? d.length : integrationRules; }
        } catch (e) {}
        document.getElementById('rules-count').textContent = `${totalRules} rules active`;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        toast.className = `${bgColor} text-white px-4 py-2 rounded-lg shadow-lg transform transition-all duration-300`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-x-full');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>
{% endblock %}
