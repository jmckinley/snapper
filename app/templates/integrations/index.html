{% extends "base.html" %}

{% block title %}Rules & Traffic - Snapper{% endblock %}

{% block header %}
<header class="bg-white shadow">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-gray-900">Rules & Traffic</h1>
                <p class="mt-1 text-sm text-gray-500">Discover what your agents are doing and create rules from live traffic</p>
            </div>
            <div class="flex items-center space-x-4">
                <span id="packs-count" class="text-sm text-gray-500">0 packs active</span>
                <span class="text-gray-300">|</span>
                <span id="rules-count" class="text-sm text-gray-500">0 rules active</span>
            </div>
        </div>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="space-y-6">

    <!-- ================================================================== -->
    <!-- SECTION 1: Discovered Activity                                     -->
    <!-- ================================================================== -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex flex-wrap justify-between items-center gap-3">
            <div class="flex items-center space-x-3">
                <span class="text-2xl">ðŸ“¡</span>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Discovered Activity</h2>
                    <p class="text-sm text-gray-500">MCP servers and tools detected from live agent traffic</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <!-- Period selector -->
                <select id="period-select" onchange="loadTrafficInsights()"
                        class="text-sm border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
                    <option value="24">Last 24 hours</option>
                    <option value="168" selected>Last 7 days</option>
                    <option value="720">Last 30 days</option>
                </select>
                <button onclick="loadTrafficInsights()" class="text-sm text-primary-600 hover:text-primary-700">
                    <svg class="w-4 h-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Traffic summary bar -->
        <div id="traffic-summary" class="px-6 py-3 bg-gray-50 border-b border-gray-200 hidden">
            <div class="flex items-center space-x-6 text-sm">
                <span><strong id="ts-evals">0</strong> evaluations</span>
                <span><strong id="ts-commands">0</strong> unique commands</span>
                <span class="text-green-600"><strong id="ts-covered">0</strong> covered</span>
                <span class="text-red-600"><strong id="ts-uncovered">0</strong> uncovered</span>
            </div>
        </div>

        <div id="traffic-container" class="divide-y divide-gray-100">
            <div class="px-6 py-12 text-center text-gray-400">
                <div class="text-4xl mb-3">ðŸ“¡</div>
                <p>Loading traffic data...</p>
            </div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- SECTION 2: Add MCP Server (manual)                                 -->
    <!-- ================================================================== -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center space-x-3">
                <span class="text-2xl">ðŸ”§</span>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Add MCP Server</h2>
                    <p class="text-sm text-gray-500">Create rules for any MCP server â€” known servers get curated packs, others get smart defaults</p>
                </div>
            </div>
        </div>
        <div class="px-6 py-4">
            <div class="flex items-end gap-3">
                <div class="flex-1 max-w-sm">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Server name</label>
                    <input type="text" id="add-server-name" placeholder="e.g. notion, linear, google-calendar"
                           list="known-servers-list"
                           class="w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 text-sm">
                    <datalist id="known-servers-list"></datalist>
                </div>
                <button onclick="addMCPServer()" id="add-server-btn"
                        class="px-4 py-2 bg-primary-600 text-white text-sm rounded-md hover:bg-primary-700 transition-colors">
                    Create Rules
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-2">Known servers (e.g. github, slack, aws) get curated rule packs. Unknown servers get 3 defaults: allow reads, approve writes, block destructive.</p>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- SECTION 3: Active Rule Packs                                       -->
    <!-- ================================================================== -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center space-x-3">
                <span class="text-2xl">ðŸ“‹</span>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Active Rule Packs</h2>
                    <p class="text-sm text-gray-500">Rule groups created from discovery or manual server setup</p>
                </div>
            </div>
        </div>
        <div id="active-packs-container" class="divide-y divide-gray-100">
            <div class="px-6 py-12 text-center text-gray-400">
                <div class="text-4xl mb-3">ðŸ“‹</div>
                <p>Loading active packs...</p>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    let trafficData = null;
    let activePacksData = [];

    document.addEventListener('DOMContentLoaded', () => {
        loadTrafficInsights();
        loadKnownServers();
        loadActivePacks();
    });

    // =====================================================================
    // Traffic Insights
    // =====================================================================

    async function loadTrafficInsights() {
        const hours = document.getElementById('period-select').value;
        const container = document.getElementById('traffic-container');

        try {
            const response = await fetch(`/api/v1/integrations/traffic/insights?hours=${hours}`);
            trafficData = await response.json();
            renderTrafficInsights(trafficData);
        } catch (error) {
            console.error('Failed to load traffic:', error);
            container.innerHTML = `<div class="px-6 py-8 text-center text-red-500 text-sm">Failed to load traffic data.</div>`;
        }
    }

    function renderTrafficInsights(data) {
        const container = document.getElementById('traffic-container');
        const summary = document.getElementById('traffic-summary');

        // Update summary bar
        document.getElementById('ts-evals').textContent = data.total_evaluations;
        document.getElementById('ts-commands').textContent = data.total_unique_commands;
        document.getElementById('ts-covered').textContent = data.total_unique_commands - data.total_uncovered;
        document.getElementById('ts-uncovered').textContent = data.total_uncovered;
        summary.classList.remove('hidden');

        if (!data.service_groups || data.service_groups.length === 0) {
            container.innerHTML = `
                <div class="px-6 py-12 text-center">
                    <div class="text-4xl mb-3">ðŸ“¡</div>
                    <p class="text-gray-500 font-medium">No agent traffic recorded yet</p>
                    <p class="text-sm text-gray-400 mt-1">Activity will appear here once agents start sending requests through Snapper</p>
                </div>
            `;
            return;
        }

        container.innerHTML = data.service_groups.map(group => {
            const coverageBadge = group.uncovered_count > 0
                ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">${group.uncovered_count} uncovered</span>`
                : `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">fully covered</span>`;

            // Determine rule count label for the button
            let addBtnLabel = 'Add Default Rules (3)';
            if (group.has_template && group.template_id) {
                // Lookup curated pack rule count
                addBtnLabel = `Add Rules`;
            }

            // Compute most recent activity timestamp
            const lastSeen = group.commands.reduce((latest, cmd) => {
                return cmd.last_seen && cmd.last_seen > latest ? cmd.last_seen : latest;
            }, '');
            const lastSeenLabel = lastSeen ? getTimeAgo(new Date(lastSeen)) : '';

            const addBtn = `<button onclick="event.stopPropagation(); addServerFromDiscovery('${escapeHtml(group.server_key)}')"
                      class="text-xs px-2 py-1 bg-primary-100 text-primary-700 rounded hover:bg-primary-200">${addBtnLabel}</button>`;

            const commandRows = group.commands.map(cmd => {
                const covered = cmd.has_matching_rule;
                const decisionBadges = Object.entries(cmd.decisions).map(([k, v]) => {
                    const color = k === 'allow' ? 'green' : k === 'deny' ? 'red' : 'yellow';
                    return `<span class="text-xs text-${color}-600">${v} ${k}</span>`;
                }).join(' Â· ');

                return `
                    <div class="pl-12 pr-6 py-2 flex items-center justify-between text-sm ${covered ? '' : 'bg-red-50/50'}">
                        <div class="flex items-center gap-2 min-w-0 flex-1">
                            <span class="w-1.5 h-1.5 rounded-full ${covered ? 'bg-green-400' : 'bg-red-400'}"></span>
                            <code class="text-xs bg-gray-100 px-1.5 py-0.5 rounded truncate max-w-md">${escapeHtml(cmd.command)}</code>
                            <span class="text-xs text-gray-400">${cmd.count}x</span>
                            <span class="text-xs text-gray-400">${decisionBadges}</span>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            ${covered
                                ? `<span class="text-xs text-green-600" title="${escapeHtml(cmd.matching_rule_names.join(', '))}">âœ“ covered</span>`
                                : `<button onclick="event.stopPropagation(); openCreateRuleModal('${escapeHtml(cmd.command)}')"
                                          class="text-xs px-2 py-1 bg-primary-600 text-white rounded hover:bg-primary-700">Create Rule</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="traffic-group">
                    <div class="px-6 py-3 cursor-pointer hover:bg-gray-50 transition-colors"
                         onclick="toggleTrafficGroup(this)">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${group.icon}</span>
                                <div>
                                    <span class="font-medium text-gray-900">${escapeHtml(group.display_name)}</span>
                                    <span class="text-xs text-gray-400 ml-2">${group.total_count} calls Â· ${group.commands.length} tools${lastSeenLabel ? ` Â· last ${lastSeenLabel}` : ''}</span>
                                </div>
                                ${coverageBadge}
                            </div>
                            <div class="flex items-center gap-3">
                                ${addBtn}
                                <svg class="w-4 h-4 text-gray-400 transition-transform traffic-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="traffic-commands hidden border-t border-gray-100">
                        ${commandRows}
                    </div>
                </div>
            `;
        }).join('');
    }

    function toggleTrafficGroup(header) {
        const commands = header.nextElementSibling;
        const chevron = header.querySelector('.traffic-chevron');
        commands.classList.toggle('hidden');
        chevron.classList.toggle('rotate-180');
    }

    function addServerFromDiscovery(serverKey) {
        document.getElementById('add-server-name').value = serverKey;
        addMCPServer();
    }

    // =====================================================================
    // Create Rule Modal (inline)
    // =====================================================================

    function openCreateRuleModal(command) {
        const action = prompt(
            `Create rule for: ${command}\n\nChoose action:\n1 = allow\n2 = require_approval\n3 = deny\n\nEnter 1, 2, or 3:`,
            '1'
        );
        if (!action) return;

        const actionMap = { '1': 'allow', '2': 'require_approval', '3': 'deny' };
        const selectedAction = actionMap[action] || 'allow';

        createRuleFromTraffic(command, selectedAction);
    }

    async function createRuleFromTraffic(command, action) {
        try {
            const response = await fetch('/api/v1/integrations/traffic/create-rule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command, action, pattern_mode: 'prefix' }),
            });
            if (!response.ok) throw new Error((await response.json()).detail || 'Failed');
            const result = await response.json();
            showToast(`Created rule: ${result.name}`, 'success');
            loadTrafficInsights();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    // =====================================================================
    // Add MCP Server
    // =====================================================================

    async function addMCPServer() {
        const name = document.getElementById('add-server-name').value.trim();
        if (!name) { showToast('Enter a server name', 'error'); return; }

        const btn = document.getElementById('add-server-btn');
        btn.disabled = true;
        btn.textContent = 'Creating...';

        try {
            const response = await fetch('/api/v1/integrations/traffic/create-server-rules', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ server_name: name }),
            });
            if (!response.ok) throw new Error((await response.json()).detail || 'Failed');
            const result = await response.json();
            const packLabel = result.source === 'rule_pack' ? 'curated' : 'default';
            showToast(`Created ${result.rules_created} ${packLabel} rules for ${name}`, 'success');
            document.getElementById('add-server-name').value = '';
            loadTrafficInsights();
            loadActivePacks();
        } catch (error) {
            showToast(error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Create Rules';
        }
    }

    async function loadKnownServers() {
        try {
            const response = await fetch('/api/v1/integrations/traffic/known-servers');
            const servers = await response.json();
            const datalist = document.getElementById('known-servers-list');
            datalist.innerHTML = servers.flatMap(s =>
                s.keys.map(k => `<option value="${k}">${s.icon} ${s.display}</option>`)
            ).join('');
        } catch (e) {
            console.warn('Could not load known servers');
        }
    }

    // =====================================================================
    // Active Rule Packs
    // =====================================================================

    async function loadActivePacks() {
        try {
            const response = await fetch('/api/v1/integrations/active-packs');
            activePacksData = await response.json();
            renderActivePacks(activePacksData);
            updateStats();
        } catch (error) {
            console.error('Failed to load active packs:', error);
            document.getElementById('active-packs-container').innerHTML = `
                <div class="text-center py-12 text-red-500 text-sm">Failed to load active packs.</div>
            `;
        }
    }

    function renderActivePacks(packs) {
        const container = document.getElementById('active-packs-container');

        if (!packs || packs.length === 0) {
            container.innerHTML = `
                <div class="px-6 py-12 text-center">
                    <div class="text-4xl mb-3">ðŸ“‹</div>
                    <p class="text-gray-500 font-medium">No rule packs active yet</p>
                    <p class="text-sm text-gray-400 mt-1">Add rules from discovered traffic above or type a server name to get started</p>
                </div>
            `;
            return;
        }

        container.innerHTML = packs.map(pack => {
            const ruleRows = pack.rules.map(rule => {
                const actionColor = rule.action === 'allow' ? 'green' : rule.action === 'deny' ? 'red' : 'yellow';
                return `
                    <div class="pl-12 pr-6 py-2 flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-${actionColor}-400"></span>
                            <span class="text-gray-900">${escapeHtml(rule.name)}</span>
                        </div>
                        <span class="px-2 py-0.5 rounded text-xs font-medium bg-${actionColor}-100 text-${actionColor}-700">${rule.action.replace('_', ' ')}</span>
                    </div>
                `;
            }).join('');

            return `
                <div class="pack-group">
                    <div class="px-6 py-3 cursor-pointer hover:bg-gray-50 transition-colors"
                         onclick="togglePackGroup(this)">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${pack.icon}</span>
                                <div>
                                    <span class="font-medium text-gray-900">${escapeHtml(pack.display_name)}</span>
                                    <span class="inline-flex items-center ml-2 px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">${pack.rule_count} rules</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="event.stopPropagation(); disableServerRules('${escapeHtml(pack.source_reference)}')"
                                        class="text-xs px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">Disable</button>
                                <svg class="w-4 h-4 text-gray-400 transition-transform pack-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="pack-rules hidden border-t border-gray-100">
                        ${ruleRows}
                    </div>
                </div>
            `;
        }).join('');
    }

    function togglePackGroup(header) {
        const rules = header.nextElementSibling;
        const chevron = header.querySelector('.pack-chevron');
        rules.classList.toggle('hidden');
        chevron.classList.toggle('rotate-180');
    }

    async function disableServerRules(sourceReference) {
        if (!confirm('Disable this rule pack and deactivate all its rules?')) return;

        try {
            const response = await fetch('/api/v1/integrations/traffic/disable-server-rules', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ server_name: sourceReference }),
            });
            if (!response.ok) throw new Error((await response.json()).detail || 'Failed');
            const result = await response.json();
            showToast(result.message, 'success');
            loadActivePacks();
            loadTrafficInsights();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    // =====================================================================
    // Stats & utilities
    // =====================================================================

    async function updateStats() {
        document.getElementById('packs-count').textContent = `${activePacksData.length} packs active`;

        let totalRules = activePacksData.reduce((sum, p) => sum + p.rule_count, 0);
        try {
            const r = await fetch('/api/v1/rules?is_active=true');
            if (r.ok) { const d = await r.json(); totalRules = Array.isArray(d) ? d.length : totalRules; }
        } catch (e) {}
        document.getElementById('rules-count').textContent = `${totalRules} rules active`;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'just now';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        const days = Math.floor(hours / 24);
        return `${days}d ago`;
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        toast.className = `${bgColor} text-white px-4 py-2 rounded-lg shadow-lg transform transition-all duration-300`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-x-full');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>
{% endblock %}
